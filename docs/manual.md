# PLATEAU QGISプラグイン(plateau-qgis-plugin)

#### PLATEAU 地形モデル以外

<img src="picture/screen01.png" width="500">

#### PLATEAU 地形モデル

<img src="picture/screen02.png" width="500">

## はじめに
### プラグインの概要

CityGML読み込みプラグイン（PLATEAU QGISプラグイン、以降「本プラグイン」と呼称）は、QGISでPLATEAUのCityGMLファイルを読み込み、QGIS上に表示するためのプラグインです。データは一時スクラッチレイヤとして読み込まれます。
### 対応データ形式

本プラグインでは「3D都市モデル標準製品仕様書 第3.0版」に対応するCityGMLファイルを指定する必要があります。

## 動作環境

本プラグインの動作環境は以下の通りです。本プラグインを実行するには、QGIS（バージョン 3.28）がインストールされている必要があります。

OS：Windows10、Windows11
QGIS：バージョン3.28
QGISのインストールについては、以下を参照ください

[QGISインストーラー](https://www.qgis.org/ja/site/forusers/alldownloads.html)


## インストール方法

本プラグインはzip圧縮されたファイルで提供します。ダウンロードしたzipファイルのインストール手順は以下の通りです。

QGISを起動
1. メニュータブの[プラグイン]から[プラグインの管理とインストール]を選択します。

<img src="picture/install00.png" width="500">

2. 表示画面の左側のタブから[ZIPからインストール]を選択します。
3. 表示画面の右側の[･･･]ボタンを選択し、エクスプローラ上で本プラグインのzipファイルを選択します。
4. 表示画面中央の[インストール]を選択します。
5. メニュータブの[プラグイン]および、[プラグインツールバー]にインストールされたプラグインが表示されます。

<img src="picture/install01.png" width="500">


インストールされたプラグインが表示されない場合、以下の手順によりプラグインを有効化する必要があります。

1. 表示画面の左側のタブから[インストール済]を選択します。
2. 本プラグイン左側のチェックボックスをチェックします。
3. 本プラグインが有効化されます。

<img src="picture/install02.png" width="500">

## アンインストール方法

本プラグインのアンインストール手順は以下の通りです。

1. メニュータブの[プラグイン]から[プラグインの管理とインストール]を選択します。
2. 表示画面の左側のタブから[インストール済]を選択します。
3. 本プラグイン(PLATEAU 3D City Model Plugin)を選択します。
4. 表示画面右下の[アンインストール]を選択します。
5. 本プラグインがアンインストールされます。

<img src="picture/uninstall01.png" width="500">

## 使用方法

<img src="picture/screen01.png" width="500">

本プラグインはCityGMLファイルを読み込み、一時スクラッチレイヤとしてQGIS上に表示します。
変換にあたっては、「日本測地系2011における経緯度座標系と東京湾平均海面を基準とする標高の複合座標参照系（EPSG：6697）」ではQGISで適切に表示できない可能性があるため、「EPSG:6668 (JGD2011)」の緯度経度の座標参照系や、「平面直角座標系」などのメートルを距離単位とする座標参照系に変換することを推奨します。

## データの準備
本プラグインにはCityGMLデータが必要です。CityGMLデータは以下のサイトからダウンロードできます。

[CityGMLデータ](https://www.geospatial.jp/ckan/dataset/plateau)

ダウンロードしたZIPファイルを解凍後に作成されるフォルダー内のすべてのファイルが必要となります。
なお、解凍後のフォルダ構成は変更しないようにしてください。変更すると属性が適切に読み込めないことがあります。

## 「PLATEAU 3D都市モデルを読み込む」実行手順

### 実行手順

1. メニュータブの[プロセシング]から[ツールボックス]を選択、ツールボックスが表示されたら、[Project PLATEAU]をダブルクリックし、[PLATEAU 3D都市モデルを読み込む]をダブルクリックしプラグインを起動します。

<img src="picture/menu01.png" width="500">

2. 本プラグインの設定画面において、各項目を設定します。

<img src="picture/operation01.png" width="500">


3. PLATEAU CityGMLファイル
> 読み込み対象のCityGMLファイルを指定します。

4. 読み込むLOD
> 同一の都市オブジェクトに複数のLOD (詳細度) が用意されている場合は、デフォルトでは最も単純なLODのみを読み込みます。目的に応じて選択してください。

5. 地物を構成する部分ごとにレイヤを分ける[オプション]
>オプションを有効にすると、一部のモデルのLOD2以上において、壁や屋根、車道や歩道といった意味的な部分に分けて地物を読み込みます。有効にすると生成される地物の数が大幅に増える可能性があります。

6. 3次元データを強制的に2次元化する[オプション]
> オプションを有効にすると、3次元の情報を捨てて平面データとして読み込みます。高さをもたないモデル (都市計画決定情報など) はこのオプションにかかわらず常に平面として読み込みます。

7. 既存の同名レイヤに追記する[オプション] (デフォルトでチェック)
> オプションを有効にすると、既存のレイヤに追記されます。

8. 変換先CRS[オプション]
> 変換先のCRSを指定します。(デフォルトではEPSG:6668 (JGD2011))

9. [実行]を押下して処理を実行
> ｢実行｣を押下すると処理が開始します。処理が完了すると、QGISのレイヤパネルに読み込まれたデータが表示されます。

<img src="picture/operation25.png" width="500">

### 災害リスク情報の取り扱い
災害リスク情報を持つ建築物モデルを読み込むと、建築物モデルとは別のレイヤ（テーブル形式のレイヤ）として出力されます。
このレイヤは、災害リスク情報が持つ属性である[description]と[scale]の単位で分割して出力されます。

- description
    - 災害リスク情報の属性を付与する元となる図又はデータの名称。
- scale
    - 洪水浸水想定区域内に存在する建築物に、浸水想定区域がもつ属性を与える際に、想定最大規模降雨あるいは計画規模降雨のいずれにより作成されたかの区分。

「3D都市モデル（Project PLATEAU）沼津市（2021年度）」CityGML（v2）の建築物モデルを読み込んだ例
<img src="picture/operation15.png" width="500">

#### 建築物モデルに災害リスク情報を付与する手順
災害リスク情報を建築物モデルを付与するためには、以下の手順を実行します。

1. レイヤパネルより、[Building]レイヤを右クリックして、[プロパティ]を選択します。
<img src="picture/operation16.png" width="300">

2. 左のタブより[テーブル結合]を選択します。
3. 下部より[+]ボタンをクリックします。
<img src="picture/operation17.png" width="500">

4. プルダウンで以下の通り選択します。
    - [結合するレイヤ]には、建築物モデルに付与したい災害リスク情報のレイヤを選択
    - [結合基準の属性]には、[parent]を選択
    - [ターゲット属性]には、[id]を選択

5. オプションで[属性名の接頭辞]にチェックを入れて、値を適宜修正します。
6. [OK]をクリックします。
<img src="picture/operation18.png" width="500">

7. 設定した内容が登録されていることを確認します。
8. [適用]をクリックしてから、[OK]をクリックします。
<img src="picture/operation19.png" width="500">

9. レイヤパネルより、[Building]レイヤを右クリックして、[属性テーブルを開く]を選択します。
<img src="picture/operation20.png" width="300">

10. 属性テーブルの右側に、5で設定した[属性名の接頭辞]+ [災害リスク情報の属性名]の名称で、属性が付与されていることを確認します。
<img src="picture/operation21.png" width="500">

## 「PLATEAU 地形モデルをメッシュとして読み込む」実行手順
<img src="picture/screen02.png" width="500">

### 実行手順
1. メニュータブの[プロセシング]から[ツールボックス]を選択、ツールボックスが表示されたら、[Project PLATEAU]をダブルクリックし、[PLATEAU 地形モデルをメッシュとして読み込む]をダブルクリックしプラグインを起動します。

<img src="picture/menu02.png" width="500">

2. 本プラグインの設定画面において、各項目を設定します。

<img src="picture/operation02.png" width="500">

3. PLATEAU CityGMLファイル
> 読み込み対象のCityGMLファイル(地形モデル)を指定します。

4. 出力メッシュファイル[オプション] 
> 出力するフォルダを指定します。指定しない場合は、一時スクラッチレイヤとして読み込まれます。

5. [実行]を押下して処理を実行
> 処理が完了すると、QGISのレイヤパネルに読み込まれたデータが表示されます。

<img src="picture/operation26.png" width="500">

### メッシュをラスタライズする手順
地形モデルはメッシュレイヤとして出力されます。ラスタに変換したい場合は、以下の手順を実行します。

1. メニュータブの[プロセシング]から[ツールボックス]を選択、ツールボックスが表示されたら、[メッシュ]をダブルクリックし、[メッシュデータをラスタライズ]をダブルクリックしプラグインを起動します。
<img src="picture/operation22.png" width="500">

2. 設定画面において、各項目を設定します。
<img src="picture/operation23.png" width="500">

3. 入力メッシュ
> [TINRelief（プラグインでインポートした地形モデルを選択）]を設定します。

4. データセットグループ
> 右の[…]より[現在アクディブなデータセットグループ]を設定

5. ピクセルサイズ
> ラスタのピクセルサイズを設定します。地形モデルは緯度経度のデータとして作成されているため、約10m（0.4秒）のラスタを作成する場合は[0.00011111]を入力します（1 / 60 / 60 * 0.4 = 0.00011111度）。

6. 出力ラスタ
> 出力するフォルダを指定します。指定しない場合は、一時スクラッチレイヤとして読み込まれます。

7. [実行]を押下して処理を実行
> 処理が完了すると、QGISのレイヤパネルに読み込まれたデータが表示されます。

<img src="picture/operation24.png" width="500">

## バッチプロセスによる複数のファイルの一括読み込み
### 注意事項
バッチプロセスで複数のファイルを同時に読み込むと大量のメモリを消費する可能性があります。  
メモリ不足となるとQGISがクラッシュする可能性があるため、メモリ使用量をご確認の上で実行してください。

###  「PLATEAU 3D都市モデルを読み込む」バッチプロセスでの実行

1. メニュータブの[プロセシング]から[ツールボックス]を選択、ツールボックスが表示されたら、[Project PLATEAU]をダブルクリックし、[PLATEAU 3D都市モデルを読み込む]をダブルクリックしプラグインを起動します。

<img src="picture/menu01.png" width="500">

2. [バッチプロセスで実行]をクリック

<img src="picture/operation03.png" width="500">

3. パラメータタブにおいて、以下の項目を読み込みたいCityGMLの数だけ設定します。

    - PLATEAU CityGMLファイル
    - 地物を構成する部分ごとにレイヤーを分ける (デフォルト いいえ)
    - 3次元データを強制的に2次元化する (デフォルト いいえ)
    - 既存の同名レイヤに追記する (デフォルト はい)
    - 変換先CRS (デフォルトで EPSG:6668 (JGD2011))

<img src="picture/operation04.png" width="500">

4. 完了時にレイヤを読み込む
> チェックを入れます。

5. ｢実行｣を押下して処理を実行
> 処理が完了すると、QGISのレイヤパネルに読み込まれたデータが表示されます。


#### オートフィル機能を使って複数のCityGMLファイルを一括読み込み

1.[オートフィル]を選択します。
2.[ファイル]を選択します。

<img src="picture/operation07.png" width="500">

3.フォルダーから読み込みたいCityGMLファイルを複数選択します。

<img src="picture/operation08.png" width="500">


####  フィルダウン機能を使ってオプションを一括登録
一番上の行の選択項目がすべての行に反映されます。

1.１番上の行の選択項目を設定し、[オートフィル]を選択します。
2.[フィルダウン]を選択します。
<img src="picture/operation09.png" width="500">

<img src="picture/operation09-2.png" width="500">

3.選択列の項目が１番目の値にすべて変更されます。

<img src="picture/operation10.png" width="500">

###  「PLATEAU 地形モデルをメッシュとして読み込む」バッチプロセスでの実行

1. メニュータブの[プロセシング]から[ツールボックス]を選択し、ツールボックスが表示されたら、[Project PLATEAU]をダブルクリックし、[PLATEAU 地形モデルをメッシュとして読み込む]をダブルクリックしプラグインを起動します。

<img src="picture/menu02.png" width="500">

2. [バッチプロセスで実行]をクリックします。

<img src="picture/operation11.png" width="500">

3. パラメータタブにおいて、以下の項目を読み込みたいCityGMLの数だけ設定します。

    - PLATEAU CityGMLファイル
    - 出力メッシュファイル (デフォルト空白)

<img src="picture/operation12.png" width="500">

4. 完了時にレイヤを読み込む
> チェックを入れます。

5.  [実行]を押下して処理を実行
> 処理が完了すると、QGISのレイヤパネルに読み込まれたデータが表示されます。

#### オートフィル機能を使って、複数のCityGMLファイルを一括読み込み

1.[オートフィル]を選択します。
2.[ファイル]を選択します。

<img src="picture/operation13.png" width="500">

3.フォルダーから読み込みたいCityGMLファイルを複数選択します。

<img src="picture/operation14.png" width="500">

## 3D表示
QGISでは上記の手順でインポートしたPLATEAUのCityGMLファイルを3Dで表示することが可能です。

### QGIS2threejsによる3D表示
ここでは、QGISプラグインの[QGIS2threejs](https://qgis2threejs.readthedocs.io/ja/docs-1.4_a/)を使用して3D表示する方法を紹介します。
<img src="picture/3dview00.png" width="500">


1. メニューバーより[プラグイン]、[プラグインの管理とリポジトリ]の順にクリックします。
<img src="picture/3dview01.png" width="500">


2. 左のタブから[すべて]を選択して、検索ワード入力欄に[threejs]と入力して、一覧より[QGIS2threejs]を選択して、下部の[インストール]をクリックします。
<img src="picture/3dview02.png" width="500">


3. [QGIS2threejs]はプロジェクトの座標系を投影座標系に変更する必要があります。画面右下の[EPSG:○○○○]ボタンをクリックして、プロジェクトの座標系を[EPSG：3857]などの投影座標系に変更します。
<img src="picture/3dview03.png" width="500">

4. レイヤパネルで、背景地図のみの表示に変更しておきます。
5. ツールバーより[QGIS2threejs]のアイコンをクリックしてプラグインを起動します。
<img src="picture/3dview04.png" width="500">

6. 左上の[Layres]より[FlatPlane]とPLATEAUのCityGMLファイル（ここでは[Building]）にチェックを入れることで、3Dでマップが表示されます。
<img src="picture/3dview05.png" width="500">


7. 標高データがある場合は、左上の[Layres]で、[FlatPlane]のチェックを外し、標高データにチェックを入れることで、CityGMLデータが地形から浮かずに表示されます。
> 標高データは、上記の通り地形モデルからラスタライズして作成するか、QGISプラグインの[ElevationTile4JP](https://qiita.com/nokonoko_1203/items/51cc0990cea4c96c4565)などで入手することが可能です。
<img src="picture/3dview06.png" width="500">


### 3Dマップビューによる3D表示
QGISには標準機能で3D表示するための[3Dマップビュー]という機能が存在します。[3Dマップビュー]の使用方法は、[QGIS公式ドキュメント](https://docs.qgis.org/3.28/ja/docs/user_manual/map_views/3d_map_view.html)を参照してください。

<img src="picture/3dview07.png" width="500">
